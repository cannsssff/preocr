name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  version-validation:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for tags
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
      
      - name: Extract version from version.py
        id: version
        run: |
          VERSION=$(python -c "import sys; sys.path.insert(0, '.'); from preocr.version import __version__; print(__version__)")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION"
      
      - name: Get git tag
        id: tag
        run: |
          TAG=$(git describe --tags --exact-match HEAD 2>/dev/null || echo "")
          if [ -z "$TAG" ]; then
            echo "No tag found for this commit"
            exit 1
          fi
          # Remove 'v' prefix if present
          TAG_VERSION=${TAG#v}
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "tag_version=$TAG_VERSION" >> $GITHUB_OUTPUT
          echo "Git tag: $TAG"
      
      - name: Validate version consistency
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG_VERSION="${{ steps.tag.outputs.tag_version }}"
          
          if [ "$VERSION" != "$TAG_VERSION" ]; then
            echo "ERROR: Version mismatch!"
            echo "Version in version.py: $VERSION"
            echo "Version in git tag: $TAG_VERSION"
            exit 1
          fi
          
          echo "✓ Version consistency check passed"
      
      - name: Install tomli for Python < 3.11
        run: |
          python -c "import sys; exit(0 if sys.version_info >= (3, 11) else 1)" || pip install --quiet tomli
      
      - name: Validate version in pyproject.toml
        run: |
          python -c "
          import sys
          sys.path.insert(0, '.')
          from preocr.version import __version__
          
          # Use tomllib for Python >= 3.11, tomli for older versions
          if sys.version_info >= (3, 11):
              import tomllib
              with open('pyproject.toml', 'rb') as f:
                  config = tomllib.load(f)
          else:
              import tomli
              with open('pyproject.toml', 'rb') as f:
                  config = tomli.load(f)
          
          # Check that version in pyproject.toml matches version.py
          pyproject_version = config['project']['version']
          if pyproject_version != __version__:
              print(f'ERROR: Version mismatch!')
              print(f'Version in version.py: {__version__}')
              print(f'Version in pyproject.toml: {pyproject_version}')
              exit(1)
          print(f'✓ pyproject.toml version matches: {__version__}')
          "
      
      - name: Validate version in __init__.py
        run: |
          python -c "
          import sys
          sys.path.insert(0, '.')
          from preocr import __version__
          from preocr.version import __version__ as version_py
          assert __version__ == version_py, f'Version mismatch: __init__.py has {__version__}, version.py has {version_py}'
          print(f'✓ __init__.py version matches: {__version__}')
          "

  build-and-publish:
    needs: version-validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
      
      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build twine
      
      - name: Run tests
        run: |
          pip install -e ".[dev]"
          pytest
      
      - name: Build package
        run: |
          rm -rf dist/ build/ *.egg-info || true
          python -m build
      
      - name: Check package
        run: |
          twine check dist/*
      
      - name: Verify package version matches tag
        run: |
          TAG_VERSION=${GITHUB_REF#refs/tags/v}
          PACKAGE_VERSION=$(python -c "import sys; sys.path.insert(0, '.'); from preocr.version import __version__; print(__version__)")
          if [ "$TAG_VERSION" != "$PACKAGE_VERSION" ]; then
            echo "ERROR: Package version ($PACKAGE_VERSION) doesn't match tag ($TAG_VERSION)"
            exit 1
          fi
          echo "✓ Package version matches tag: $PACKAGE_VERSION"
      
      - name: Publish to PyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          if [ -z "$TWINE_PASSWORD" ]; then
            echo "ERROR: PYPI_API_TOKEN secret is not set in GitHub repository settings"
            echo "Go to: Settings → Secrets and variables → Actions → New repository secret"
            echo "Name: PYPI_API_TOKEN"
            exit 1
          fi
          twine upload dist/*
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')

