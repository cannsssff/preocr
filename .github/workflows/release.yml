name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  version-validation:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for tags
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
      
      - name: Extract version from version.py
        id: version
        run: |
          VERSION=$(python -c "import sys; sys.path.insert(0, '.'); from preocr.version import __version__; print(__version__)")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION"
      
      - name: Get git tag
        id: tag
        run: |
          TAG=$(git describe --tags --exact-match HEAD 2>/dev/null || echo "")
          if [ -z "$TAG" ]; then
            echo "No tag found for this commit"
            exit 1
          fi
          # Remove 'v' prefix if present
          TAG_VERSION=${TAG#v}
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "tag_version=$TAG_VERSION" >> $GITHUB_OUTPUT
          echo "Git tag: $TAG"
      
      - name: Validate version consistency
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG_VERSION="${{ steps.tag.outputs.tag_version }}"
          
          if [ "$VERSION" != "$TAG_VERSION" ]; then
            echo "ERROR: Version mismatch!"
            echo "Version in version.py: $VERSION"
            echo "Version in git tag: $TAG_VERSION"
            exit 1
          fi
          
          echo "✓ Version consistency check passed"
      
      - name: Install tomli for Python < 3.11
        run: |
          python -c "import sys; exit(0 if sys.version_info >= (3, 11) else 1)" || pip install --quiet tomli
      
      - name: Validate version in pyproject.toml
        run: |
          python -c "
          import sys
          sys.path.insert(0, '.')
          from preocr.version import __version__
          
          # Use tomllib for Python >= 3.11, tomli for older versions
          if sys.version_info >= (3, 11):
              import tomllib
              with open('pyproject.toml', 'rb') as f:
                  config = tomllib.load(f)
          else:
              import tomli
              with open('pyproject.toml', 'rb') as f:
                  config = tomli.load(f)
          
          # Check that pyproject.toml uses dynamic version (not static)
          project_config = config.get('project', {})
          if 'version' in project_config:
              print(f'ERROR: pyproject.toml should use dynamic version, not static!')
              print(f'Found static version: {project_config[\"version\"]}')
              exit(1)
          
          if 'dynamic' not in project_config or 'version' not in project_config['dynamic']:
              print(f'ERROR: pyproject.toml should have dynamic = [\"version\"]')
              exit(1)
          
          # Check that setuptools.dynamic.version is configured
          setuptools_config = config.get('tool', {}).get('setuptools', {})
          dynamic_config = setuptools_config.get('dynamic', {})
          if 'version' not in dynamic_config:
              print(f'ERROR: tool.setuptools.dynamic.version not configured')
              exit(1)
          
          print(f'✓ pyproject.toml correctly uses dynamic version from version.py: {__version__}')
          "
      
      - name: Validate version in __init__.py
        run: |
          python -c "
          import sys
          sys.path.insert(0, '.')
          from preocr import __version__
          from preocr.version import __version__ as version_py
          assert __version__ == version_py, f'Version mismatch: __init__.py has {__version__}, version.py has {version_py}'
          print(f'✓ __init__.py version matches: {__version__}')
          "

  build-and-publish:
    needs: version-validation
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write  # Required for trusted publishing to PyPI
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
      
      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build twine
      
      - name: Run tests
        run: |
          pip install -e ".[dev]"
          pytest
      
      - name: Verify version before build
        run: |
          TAG_VERSION=${GITHUB_REF#refs/tags/v}
          CODE_VERSION=$(python -c "import sys; sys.path.insert(0, '.'); from preocr.version import __version__; print(__version__)")
          echo "Tag version: $TAG_VERSION"
          echo "Code version: $CODE_VERSION"
          if [ "$TAG_VERSION" != "$CODE_VERSION" ]; then
            echo "ERROR: Code version ($CODE_VERSION) doesn't match tag ($TAG_VERSION)"
            exit 1
          fi
          echo "✓ Version check passed: $CODE_VERSION"
      
      - name: Build package
        run: |
          rm -rf dist/ build/ *.egg-info || true
          python -m build
          echo "Built packages:"
          ls -lh dist/
      
      - name: Check package
        run: |
          twine check dist/*
      
      - name: Verify built package version
        run: |
          TAG_VERSION=${GITHUB_REF#refs/tags/v}
          # Extract version from built wheel filename
          WHEEL_FILE=$(ls dist/*.whl 2>/dev/null | head -1)
          if [ -z "$WHEEL_FILE" ]; then
            echo "ERROR: No wheel file found in dist/"
            exit 1
          fi
          echo "Wheel file: $WHEEL_FILE"
          # Extract version from filename: preocr-X.Y.Z-py3-none-any.whl
          WHEEL_VERSION=$(echo "$WHEEL_FILE" | sed -n 's/.*preocr-\([0-9]\+\.[0-9]\+\.[0-9]\+\).*/\1/p')
          echo "Wheel version: $WHEEL_VERSION"
          echo "Tag version: $TAG_VERSION"
          if [ "$WHEEL_VERSION" != "$TAG_VERSION" ]; then
            echo "ERROR: Built package version ($WHEEL_VERSION) doesn't match tag ($TAG_VERSION)"
            echo "This should not happen - the build is using wrong version!"
            exit 1
          fi
          echo "✓ Built package version matches tag: $WHEEL_VERSION"
      
      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')

