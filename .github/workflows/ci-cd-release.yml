name: CI/CD Release Pipeline

# This workflow runs when code is merged to main
# It performs: version bump â†’ lint â†’ test â†’ tag â†’ publish

on:
  push:
    branches: [main]
    paths-ignore:
      - '**.md'
      - '.github/workflows/RELEASE_WORKFLOW.md'
      - '.github/PYPI_SETUP.md'
      - 'CHANGELOG.md'
      - 'LICENSE'

jobs:
  # Step 1: Version Bump
  version-bump:
    runs-on: ubuntu-latest
    # Skip if this is already a version bump commit, [skip ci], or [no bump] is in the message
    if: |
      !contains(github.event.head_commit.message, 'chore: bump version') &&
      !contains(github.event.head_commit.message, '[skip ci]') &&
      !contains(github.event.head_commit.message, '[ci skip]') &&
      !contains(github.event.head_commit.message, '[skip actions]') &&
      !contains(github.event.head_commit.message, '[actions skip]') &&
      !contains(github.event.head_commit.message, '[no bump]') &&
      !contains(github.event.head_commit.message, '[skip version]') &&
      !contains(github.event.head_commit.message, '[no version]')
    permissions:
      contents: write  # Required to push commits and tags
    outputs:
      new_version: ${{ steps.bump.outputs.new_version }}
      should_bump: ${{ steps.bump.outputs.should_bump }}
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for tag comparison
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Configure Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
      
      - name: Get current version
        id: current_version
        run: |
          CURRENT_VERSION=$(python -c "import sys; sys.path.insert(0, '.'); from preocr.version import __version__; print(__version__)")
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $CURRENT_VERSION"
      
      - name: Check if version bump needed
        id: bump
        run: |
          set +e  # Don't exit on error
          python bump_version.py --dry-run > bump_output.txt 2>&1
          EXIT_CODE=$?
          cat bump_output.txt
          
          # Check if version would change
          if grep -q "New version:" bump_output.txt; then
            NEW_VERSION=$(grep "New version:" bump_output.txt | awk '{print $3}')
            echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
            echo "should_bump=true" >> $GITHUB_OUTPUT
            echo "Version bump needed: $NEW_VERSION"
          elif grep -q "No commits found since last tag" bump_output.txt; then
            echo "should_bump=false" >> $GITHUB_OUTPUT
            echo "new_version=${{ steps.current_version.outputs.current_version }}" >> $GITHUB_OUTPUT
            echo "No commits found since last tag - no version bump needed"
          elif [ $EXIT_CODE -eq 0 ] && grep -q "Detected bump type:" bump_output.txt; then
            # Script ran successfully and detected a bump type
            NEW_VERSION=$(grep "New version:" bump_output.txt | awk '{print $3}' || echo "")
            if [ -n "$NEW_VERSION" ]; then
              echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
              echo "should_bump=true" >> $GITHUB_OUTPUT
              echo "Version bump needed: $NEW_VERSION"
            else
              echo "should_bump=false" >> $GITHUB_OUTPUT
              echo "new_version=${{ steps.current_version.outputs.current_version }}" >> $GITHUB_OUTPUT
              echo "No version bump needed"
            fi
          else
            echo "should_bump=false" >> $GITHUB_OUTPUT
            echo "new_version=${{ steps.current_version.outputs.current_version }}" >> $GITHUB_OUTPUT
            echo "No version bump needed, keeping current version: ${{ steps.current_version.outputs.current_version }}"
          fi
          set -e  # Re-enable exit on error
      
      - name: Bump version
        if: steps.bump.outputs.should_bump == 'true'
        run: |
          python bump_version.py --no-commit
          NEW_VERSION="${{ steps.bump.outputs.new_version }}"
          echo "âœ“ Version bumped to $NEW_VERSION"
      
      - name: Commit and push version bump
        if: steps.bump.outputs.should_bump == 'true'
        run: |
          git add preocr/version.py
          git commit -m "chore: bump version to ${{ steps.bump.outputs.new_version }}"
          git push origin main
          echo "âœ“ Pushed version bump to main"

  # Step 2: Linting
  lint:
    runs-on: ubuntu-latest
    needs: version-bump
    if: |
      always() &&
      !contains(github.event.head_commit.message, '[skip ci]') &&
      !contains(github.event.head_commit.message, '[ci skip]') &&
      !contains(github.event.head_commit.message, '[skip actions]') &&
      !contains(github.event.head_commit.message, '[actions skip]')
    
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.9"
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libmagic1
      
      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      
      - name: Run Black (auto-fix)
        run: |
          # Auto-format with black
          black preocr/ tests/ examples/
          echo "âœ“ Code formatted with Black"
      
      - name: Run Ruff check (auto-fix)
        run: |
          # Auto-fix code issues with ruff
          ruff check preocr/ tests/ examples/ --fix
          echo "âœ“ Code checked and auto-fixed with Ruff"
      
      - name: Run Ruff format (auto-fix)
        run: |
          # Auto-format with ruff format
          ruff format preocr/ tests/ examples/
          echo "âœ“ Code formatted with Ruff format"
      
      - name: Run mypy
        run: |
          mypy preocr/ --ignore-missing-imports

  # Step 3: Testing
  test:
    runs-on: ubuntu-latest
    needs: [version-bump, lint]
    if: |
      always() &&
      needs.lint.result == 'success' &&
      !contains(github.event.head_commit.message, '[skip ci]') &&
      !contains(github.event.head_commit.message, '[ci skip]') &&
      !contains(github.event.head_commit.message, '[skip actions]') &&
      !contains(github.event.head_commit.message, '[actions skip]')
    strategy:
      matrix:
        python-version: ["3.9", "3.10", "3.11", "3.12"]
    
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libmagic1
      
      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      
      - name: Run tests
        run: |
          pytest --cov=preocr --cov-report=term-missing --cov-report=xml
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  # Step 4: Create Tag and Publish
  tag-and-publish:
    runs-on: ubuntu-latest
    needs: [version-bump, lint, test]
    # Only run if lint and test succeeded, version was bumped, and version-bump job actually ran
    # Skip if [no bump] or [skip ci] is in commit message, or if version-bump job was skipped
    if: |
      needs.lint.result == 'success' &&
      needs.test.result == 'success' &&
      needs.version-bump.result != 'skipped' &&
      needs.version-bump.outputs.should_bump == 'true' &&
      !contains(github.event.head_commit.message, '[skip ci]') &&
      !contains(github.event.head_commit.message, '[ci skip]') &&
      !contains(github.event.head_commit.message, '[skip actions]') &&
      !contains(github.event.head_commit.message, '[actions skip]') &&
      !contains(github.event.head_commit.message, '[no bump]') &&
      !contains(github.event.head_commit.message, '[skip version]') &&
      !contains(github.event.head_commit.message, '[no version]')
    permissions:
      contents: write  # Required to create and push tags
      id-token: write  # Required for trusted publishing to PyPI
    
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Configure Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
      
      - name: Extract version from version.py
        id: version
        run: |
          VERSION=$(python -c "import sys; sys.path.insert(0, '.'); from preocr.version import __version__; print(__version__)")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION"
      
      - name: Check if version was bumped
        id: check_bump
        run: |
          if [ "${{ needs.version-bump.outputs.should_bump }}" == "true" ]; then
            echo "should_publish=true" >> $GITHUB_OUTPUT
            echo "Version was bumped, will publish"
          else
            echo "should_publish=false" >> $GITHUB_OUTPUT
            echo "No version bump, skipping publish"
          fi
      
      - name: Verify version matches bumped version
        if: needs.version-bump.outputs.should_bump == 'true'
        run: |
          EXPECTED_VERSION="${{ needs.version-bump.outputs.new_version }}"
          ACTUAL_VERSION="${{ steps.version.outputs.version }}"
          if [ -z "$EXPECTED_VERSION" ]; then
            echo "ERROR: Expected version is empty!"
            exit 1
          fi
          if [ "$EXPECTED_VERSION" != "$ACTUAL_VERSION" ]; then
            echo "ERROR: Version mismatch!"
            echo "Expected: $EXPECTED_VERSION"
            echo "Actual: $ACTUAL_VERSION"
            exit 1
          fi
          echo "âœ“ Version check passed: $ACTUAL_VERSION"
      
      - name: Fetch latest refs
        if: needs.version-bump.outputs.should_bump == 'true'
        run: |
          git fetch origin main --tags
          git checkout main
          git pull origin main
          echo "âœ“ Fetched latest changes from main"
      
      - name: Check if tag already exists
        id: check_tag
        run: |
          TAG="v${{ steps.version.outputs.version }}"
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Tag $TAG already exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Tag $TAG does not exist, will create it"
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
      
      - name: Create and push git tag
        if: steps.check_tag.outputs.exists == 'false' && needs.version-bump.outputs.should_bump == 'true'
        run: |
          TAG="${{ steps.check_tag.outputs.tag }}"
          # Ensure we're on the latest commit
          git checkout main
          git pull origin main
          # Verify we're on the right commit with the version bump
          CURRENT_COMMIT=$(git rev-parse HEAD)
          echo "Current commit: $CURRENT_COMMIT"
          echo "Current commit message:"
          git log -1 --pretty=format:"%s"
          # Verify version in the code matches what we expect
          CODE_VERSION=$(python -c "import sys; sys.path.insert(0, '.'); from preocr.version import __version__; print(__version__)")
          EXPECTED_VERSION="${{ steps.version.outputs.version }}"
          if [ "$CODE_VERSION" != "$EXPECTED_VERSION" ]; then
            echo "ERROR: Version mismatch before tagging!"
            echo "Expected: $EXPECTED_VERSION"
            echo "Actual in code: $CODE_VERSION"
            exit 1
          fi
          # Create annotated tag on current HEAD
          git tag -a "$TAG" -m "Release $TAG"
          # Verify tag was created
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "âœ“ Tag $TAG created successfully"
            git show "$TAG" --no-patch
          else
            echo "ERROR: Tag creation failed!"
            exit 1
          fi
          # Push the tag
          git push origin "$TAG"
          echo "âœ“ Created and pushed tag $TAG"
      
      - name: Create GitHub Release
        if: steps.check_tag.outputs.exists == 'false' && needs.version-bump.outputs.should_bump == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.check_tag.outputs.tag }}
          name: Release ${{ steps.check_tag.outputs.tag }}
          generate_release_notes: true
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Install system dependencies
        if: needs.version-bump.outputs.should_bump == 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y libmagic1
      
      - name: Install build dependencies
        if: needs.version-bump.outputs.should_bump == 'true'
        run: |
          python -m pip install --upgrade pip
          pip install build twine
      
      - name: Install test dependencies
        if: needs.version-bump.outputs.should_bump == 'true'
        run: |
          pip install -e ".[dev]"
      
      - name: Run final tests before publish
        if: needs.version-bump.outputs.should_bump == 'true'
        run: |
          pytest
      
      - name: Build package
        if: needs.version-bump.outputs.should_bump == 'true'
        run: |
          rm -rf dist/ build/ *.egg-info || true
          python -m build
          echo "Built packages:"
          ls -lh dist/
      
      - name: Check package
        if: needs.version-bump.outputs.should_bump == 'true'
        run: |
          twine check dist/*
      
      - name: Verify built package version
        if: needs.version-bump.outputs.should_bump == 'true'
        run: |
          TAG_VERSION="${{ steps.version.outputs.version }}"
          # Extract version from built wheel filename
          WHEEL_FILE=$(ls dist/*.whl 2>/dev/null | head -1)
          if [ -z "$WHEEL_FILE" ]; then
            echo "ERROR: No wheel file found in dist/"
            exit 1
          fi
          echo "Wheel file: $WHEEL_FILE"
          # Extract version from filename: preocr-X.Y.Z-py3-none-any.whl
          WHEEL_VERSION=$(echo "$WHEEL_FILE" | sed -n 's/.*preocr-\([0-9]\+\.[0-9]\+\.[0-9]\+\).*/\1/p')
          echo "Wheel version: $WHEEL_VERSION"
          echo "Tag version: $TAG_VERSION"
          if [ "$WHEEL_VERSION" != "$TAG_VERSION" ]; then
            echo "ERROR: Built package version ($WHEEL_VERSION) doesn't match tag ($TAG_VERSION)"
            exit 1
          fi
          echo "âœ“ Built package version matches tag: $WHEEL_VERSION"
      
      - name: Publish to PyPI
        if: needs.version-bump.outputs.should_bump == 'true' && steps.check_tag.outputs.exists == 'false'
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.PYPI_API_TOKEN }}
      
      - name: Skip publish (no version bump)
        if: needs.version-bump.outputs.should_bump == 'false'
        run: |
          echo "â„¹ï¸ No version bump detected, skipping PyPI publish"
          echo "To publish, ensure your commits use conventional commits:"
          echo "  - fix: â†’ patch version"
          echo "  - feat: â†’ minor version"
          echo "  - feat!: â†’ major version"
      
      - name: Summary - Published
        if: needs.version-bump.outputs.should_bump == 'true' && steps.check_tag.outputs.exists == 'false'
        run: |
          echo "## ðŸŽ‰ Release Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** ${{ steps.check_tag.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**Published to PyPI:** âœ…" >> $GITHUB_STEP_SUMMARY
      
      - name: Summary - No Publish
        if: needs.version-bump.outputs.should_bump == 'false'
        run: |
          echo "## âœ… CI/CD Complete (No Release)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Current version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** No version bump needed - skipped PyPI publish" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** Use conventional commits to trigger version bump:" >> $GITHUB_STEP_SUMMARY
          echo "- \`fix:\` â†’ patch version" >> $GITHUB_STEP_SUMMARY
          echo "- \`feat:\` â†’ minor version" >> $GITHUB_STEP_SUMMARY
          echo "- \`feat!:\` â†’ major version" >> $GITHUB_STEP_SUMMARY

  # Summary job that always runs
  summary:
    runs-on: ubuntu-latest
    needs: [version-bump, lint, test]
    if: always()
    
    steps:
      - name: Create summary
        run: |
          if [ "${{ needs.version-bump.outputs.should_bump }}" == "true" ]; then
            echo "## ðŸŽ‰ CI/CD Pipeline Complete!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Version:** ${{ needs.version-bump.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
            echo "**Status:** âœ… Version bumped, linted, tested, tagged, and published to PyPI" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âœ… CI/CD Pipeline Complete!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Current version:** ${{ needs.version-bump.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
            echo "**Status:** âœ… Linted and tested. No version bump needed." >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Lint:** ${{ needs.lint.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Tests:** ${{ needs.test.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY

